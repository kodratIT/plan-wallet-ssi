@startuml BC Wallet - Dynamic Credential Issuance
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Dynamic.puml

LAYOUT_WITH_LEGEND()

title Dynamic Diagram - Credential Issuance Flow

Person(user, "User", "BC Wallet user")
Container(mobile_app, "Mobile App", "React Native", "User interface")
Container(credo_agent, "Credo Agent", "AFJ", "SSI agent")
Container(indy_sdk, "Indy SDK", "Native", "Blockchain client")
System_Ext(mediator, "Mediator Service", "Message router")
System_Ext(issuer, "Credential Issuer", "Aries Agent")
System_Ext(ledger, "Indy Ledger", "Blockchain")

' Connection Phase
Rel(user, mobile_app, "1. Scan QR Code", "Connection invitation")
Rel(mobile_app, credo_agent, "2. Parse invitation")
Rel(credo_agent, issuer, "3. Send connection request", "DIDComm (via mediator)")
Rel(issuer, credo_agent, "4. Send connection response", "DIDComm")
Rel(credo_agent, mobile_app, "5. Connection established")
Rel(mobile_app, user, "6. Show 'Connected'")

' Credential Offer Phase
Rel(issuer, mediator, "7. Send credential offer", "DIDComm message")
Rel(mediator, mobile_app, "8. Push notification", "FCM/APNs")
Rel(mobile_app, mediator, "9. Poll for messages")
Rel(mediator, mobile_app, "10. Return credential offer")

Rel(mobile_app, credo_agent, "11. Process offer")
Rel(credo_agent, indy_sdk, "12. Fetch schema & cred def")
Rel(indy_sdk, ledger, "13. Query ledger", "Indy protocol")
Rel(ledger, indy_sdk, "14. Return metadata")

Rel(credo_agent, mobile_app, "15. Credential preview ready")
Rel(mobile_app, user, "16. Display offer details")
Rel(user, mobile_app, "17. Accept offer")

' Credential Request Phase
Rel(mobile_app, credo_agent, "18. Accept credential offer")
Rel(credo_agent, credo_agent, "19. Generate credential request\n(with blinded master secret)")
Rel(credo_agent, issuer, "20. Send credential request", "DIDComm")

' Credential Issuance Phase
Rel(issuer, issuer, "21. Create credential\n(sign with private key)")
Rel(issuer, credo_agent, "22. Send credential", "DIDComm")

Rel(credo_agent, indy_sdk, "23. Verify signature")
Rel(indy_sdk, ledger, "24. Fetch issuer public key")
Rel(ledger, indy_sdk, "25. Return public key")

Rel(credo_agent, credo_agent, "26. Store credential\n(encrypted with Askar)")
Rel(credo_agent, mobile_app, "27. Credential stored")
Rel(mobile_app, user, "28. Show success")

Rel(credo_agent, issuer, "29. Send acknowledgment", "DIDComm")

SHOW_LEGEND()

@enduml
